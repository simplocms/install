# SIMPLO CMS

CMS built with Laravel 5.7!

Requirements:

* PHP >= 7.1.3
* OpenSSL PHP Extension
* PDO MySQL PHP Extension
* Mbstring PHP Extension
* Tokenizer PHP Extension
* XML PHP Extension
* MySQL database ^5.6
* Enabled mod_rewrite for Apache
* GD or Imagick PHP Extension (Imagick recommended)

Development requirements:

* cURL extension
* SQLite3 extension
* GD extension

> More detailed information for Laravel 5.5 can be found in official documentation: https://laravel.com/docs/5.5

## CMS setup

**If you want to setup Docker container for development, you need to install `docker-compose` and follow guide in `.docker/README.md`.**

> *This installation guide is written for "LAMP" stack environment.*

If you are using project's docker image, connect to the `web` container and proceed with installation in the container:

```bash
# Run this in project root directory
$ docker-compose exec web /bin/bash
```

#### Composer

> If you do not have composer on your machine, [download](https://getcomposer.org/download/) and install it. Composer is already present in Docker container.

```bash
$ composer install
```

#### Node.js

> If you do not have Node.js on your machine, [download](https://nodejs.org/en/) and install it. Currently recommended version is 8.*. Node.js is already present in Docker container.

```bash
# Install npm dependencies
$ npm i
```

> TIP for windows users: Run installation with `--no-bin-links` argument.

#### File permissions

You have to make sure, that Apache user has write permissions to directories `bootstrap` and `storage`.

```bash
# Change owner to www-data group (apache)
:# chown -R :www-data .
# Setup permissions
:# chmod -R ug+rwx ./bootstrap ./storage
```

#### Environment configuration

```bash
# Copy preconfigured .env.example to .env
$ copy .env.example .env
# Generate application key
$ php artisan key:generate
```

> If you are using Docker container, all important configuration is set within the container.


##### Basic Laravel configuration

* **APP_ENV** - this value defines environment used on the server. It can have two different values: local that prepares the application for testing on the development server, and production that will fully optimize the application for the mass usage in production.
* **APP_DEBUG** - this field determines whether debugging tools will be ON or OFF. Keep it in sync with APP_ENV, where if `APP_ENV=production` then always use `APP_DEBUG=false`, otherwise `APP_DEBUG=true`.
* **APP_KEY** - this is a random key generated using command `php artisan key:generate`. It is used in the process of generating and verifying passwords - so if you ever decide to change this value after the initial setup, it will cause all passwords generated by Laravel to be no longer valid.
* **APP_URL** -  this variable should contain your application’s address. It’s used to generate urls in application.
* **DB_…** - these six fields are used to configure a connection to your database. Most of the fields are self-explanatory. The only exception is “DB_CONNECTION”, where you should use “mysql”.
* **CACHE_DRIVER** - should have value `file`, which is standard for CMS. Cache files will be stored in “storage/framework/cache”. Don’t forget that `www-data` user needs write permissions to that directory.
* **SESSION_DRIVER** - should have value `file`, which is standard for CMS. Session files will be stored in “storage/framework/sessions”. Don’t forget that `www-data` user needs write permissions to that directory.
* **SESSION_LIFETIME** - this value decides, how long will user's session last in minutes.

##### CMS configuration

* **SENTRY_DSN** - keep default value. It helps us to track issues in system and fix them.
* **GOOGLE_CLIENT_…** - keep defaults for these two values. It is reference to our google application for connecting to google analytics on dashboard of administration.
* **TESTING_DB_DATABASE** - name of the existing database, that use used while running tests for temporary data. User defined in `DB_USERNAME` must have access to this database.
* **SIMPLE_PAGE_URL** - when set to `true`, sub-pages will have own URL address, but when is `false`, url addresses of sub-pages will be prefixed with url address of parent pages.

#### Migrate database

At this point, database connection should be configured. If there is a problem, you will know immediately.

```bash
# Creates database tables and seeds basic data
$ php artisan migrate --seed
```

#### Compile your assets

##### Development

In development you want to compile assets to be debuggable and readable.

```bash
# Keep watching changes in source code and recompile on every change:
$ npm run watch
# OR single time compilation:
$ npm run dev
```

##### Production

On production server you want to compile assets to be minimized and not-readable, without debuggers and console logs:

```bash
# Build production assets:
$ npm run prod
```

## Template installation

1) You have to copy a template into directory `resources/themes`.
2) If template contains `modules` directory, go to the template's directory and run command `composer dump-autoload`.
3) Sign in into CMS administration and go to Settings > Template (Nastavení > Šablona).
4) Click on “Change” (Změnit) and then activate your template.


## Image optimization

Media Library can optimize uploaded PNGs, JPGs, SVGs and GIFs by running them through a chain of various image optimization tools. It will use these optimizers if they are present on the server:

- [MozJPEG](https://github.com/mozilla/mozjpeg)
- [Optipng](http://optipng.sourceforge.net/)
- [Pngquant 2](https://pngquant.org/)
- [SVGO](https://github.com/svg/svgo)
- [Gifsicle](http://www.lcdf.org/gifsicle/)

Here's how to install all the optimizers with APT:

```bash
$ npm install -g mozjpeg
$ apt-get install optipng
$ apt-get install pngquant
$ npm install -g svgo
$ apt-get install gifsicle
```

> TIP: when installing mozjpeg as root, you might use additional parameter `--unsafe-perm=true` if you get permission error.

## Commands

#### Clear all cache

Clears all cache including routes, views etc. 

```bash
$ php artisan clearcache
```

#### Run tests

Prepares testing environment and runs tests:
> This command takes same arguments as `phpunit`.

**Do not interrupt this command, wait until it ends!**

```bash
$ php artisan run-tests
```

# For developers:

## Verzování

### Verze systému
Verze systému se skládá ze tří částí - `A.B.C`.
Číslo *A* je nejvyšší a navyšuje se pouze při podstatné změně systému, kdy se například předělává větší část funkcionality, nebo se upgraduje na vyšší verzi laravelu. Vždy se navyšuje při novém releasu. Commit je pak označený jako `Upgrade`.

Číslo *B* se navyšuje při přidání nové funkcionality do systému. Commit je pak označený jako `Feature`.

Číslo *C* se navyšuje při opravě chyby. Commit je pak označený jako `Fix`.

### Verze modulů a šablon
Moduly a šablony se verzují na stejném principu jako systém, s tím rozdílem, že číslo *A* je navýšeno, pokud se upravuje funkcionalita z důvodu změny v systému.

## Sledování kompatibility
V souborech `composer.json` systému, modulů a šablon jsou pomocné prostředky ke sledování vzájemné kompatibility.

### Moduly

Soubor `composer.json` systému obsahuje klíč `system-change-track`, pod kterým je uložen tracking změn jednotlivých částí systému, které mohou ovlivnit fungování některého modulu. Pokud je tedy provedena změna některé části, která by měla ovlivnit fungování některého z modulů, navýší se jedno nebo více trackovacích čísel u příslušných částí.

Trackovací číslo se skládá ze dvou částí - `A.B`, kdy se číslo *A* navyšuje pouze při větším zásahu do systému - a tedy potřebě větší úpravy modulu. Číslo *B* se navyšuje při menší změně systému a tedy menší potřebné úpravě modulu.

Tato trackovací čísla se porovnávají s trackovacími čísly v souboru `composer.json`. Při úpravě modulu z důvodu změny v systému je pak tedy potřeba, aby tato čísla odpovídala aktuálním trackovacím číslům systému, jinak bude modul považován za neaktuální.

Při vytváření modulů je potřeba dobře zvážit, které závislosti na systému modul má. V nejzákladnějším případě by měl obsahovat tracovací čísla `other` (pro obecnou funkcionalitu), `config` (konfigurace). Moduly pro Grid Editor musí obsahovat trackovací číslo `grideditor` a moduly registrující vlastní URL adresy zase `url`. 

Moduly si mohou vymýšlet nová trackovací čísla a nemusí se držet těch existujících. Pokud tedy modul využívá třídu `App\Models\Article\Article`, může uvést nové trackovací číslo `model-article` s počáteční hodnotou `1.0`. 

### Šablony

Pro sledování kompatibility šablony slouží trackovací číslo pod klíčem `theme-change-track`, které obsahují soubory `composer.json` systému a šablony. Toto trackovací číslo se skládá ze dvou částí - `A.B`, kdy se číslo *A* navyšuje pouze při větším zásahu do systému - a tedy potřebě větší úpravy šablony. Číslo *B* se navyšuje při menší změně systému a tedy menší potřebné úpravě šablony.
